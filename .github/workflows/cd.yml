name: CD

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  samples:
    strategy:
      matrix:
        os: [linux, macos, windows]
        what: [team-chat, jumpy-lion]
        include: 
          - what: team-chat
            map: /Game/TeamChatSample/Maps/TeamChatSample
          - what: jumpy-lion
            map: /Game/JumpyLion/Maps/JumpyLion
          - os: linux
            path: LinuxNoEditor
          - os: macos
            path: MacNoEditor
          - os: windows
            path: WindowsNoEditor
            
    name: 📦 Package ${{ matrix.what }} - ${{ matrix.os }}
    runs-on: [self-hosted, '${{ matrix.os }}']

    steps:
      - uses: actions/checkout@v2
        name: 🛒 Checkout
        with:
          lfs: true

      - name: 📦 Package
        run: ue4 package Shipping -NoPCH -NoSharedPCH -DisableUnity -map=${{ matrix.map }}

      - uses: actions/upload-artifact@v2
        with:
          name: ${{matrix.what}}-${{matrix.os}}
          path: |
            dist/${{matrix.path}}
            !**/Manifest_NonUFSFiles*.txt
        name: 📁 Upload artifact

  plugin:
    name: 📦 Package plugin
    runs-on: [self-hosted, linux]

    steps:
      - uses: actions/checkout@v2
        name: 🛒 Checkout
        with:
          lfs: true

      - name: 📦 Package plugin
        run: |
          cd Plugins/StreamChat
          ue4 package -NoPCH -NoSharedPCH -DisableUnity

      # Satisfy marketplace requirements
      - name: Move SourceFiles
        run: |
          mkdir Plugins/StreamChat/dist/Content/SourceFiles
          find Plugins/StreamChat/dist -type f '(' -name "*.png" -o -name "*.svg" ')' -print0 | xargs -0 mv -t Plugins/StreamChat/dist/Content/SourceFiles

      - uses: actions/upload-artifact@v2
        with:
          name: StreamChat
          path: |
            Plugins/StreamChat/dist
            !**/Binaries
            !**/Intermediate
        name: 📁 Upload plugin artifact
