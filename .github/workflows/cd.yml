name: CD

on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]

  workflow_dispatch:
    inputs:
      build-configuration:
        description: 'Unreal Engine build configuration'
        required: false
        default: Shipping
        options:
          - Debug
          - DebugGame
          - Development
          - Shipping
          - Test

jobs:
  samples:
    strategy:
      fail-fast: false
      matrix:
        platform: [Linux, Mac, "Win64"]
        what: [team-chat, jumpy-lion]
        include: 
          - what: team-chat
            map: /Game/TeamChatSample/Maps/TeamChatSample.TeamChatSample
          - what: jumpy-lion
            map: /Game/JumpyLion/Maps/JumpyLion.JumpyLion
          - platform: Linux
            path: LinuxNoEditor
          - platform: Mac
            path: MacNoEditor
          - platform: Win64
            path: WindowsNoEditor
            
    name: ğŸ“¦ Package ${{ matrix.what }} - ${{ matrix.platform }}
    runs-on: [self-hosted, 'UE_${{ matrix.platform }}']

    steps:
      - uses: actions/checkout@v2
        name: ğŸ›’ Checkout
        with:
          lfs: true

      - name: ğŸ“¦ Package
        run: |
          sed -i '' 's|/Engine/Maps/Entry.Entry|${{ matrix.map }}|' Config/DefaultEngine.ini
          ue4 package ${{ github.event.inputs.build-configuration }} -platform=${{ matrix.platform }} -mapstocook="${{ matrix.map }}"
      
      - name: Make executable
        if: ${{ matrix.platform == 'Mac' }}
        run: chmod +x dist/${{ matrix.path }}/StreamChatSample-${{ matrix.platform }}-${{ github.event.inputs.build-configuration }}.app/Contents/MacOS/StreamChatSample-${{ matrix.platform }}-${{ github.event.inputs.build-configuration }}

      - uses: actions/upload-artifact@v2
        with:
          name: ${{ matrix.what }}-${{ matrix.platform }}
          path: |
            dist/${{ matrix.path }}
            !**/Manifest_NonUFSFiles*.txt
        name: ğŸ“ Upload artifact

  plugin:
    name: ğŸ”Œ Package plugin
    runs-on: [self-hosted]

    steps:
      - uses: actions/checkout@v2
        name: ğŸ›’ Checkout
        with:
          lfs: true

      - name: ğŸ“¦ Package plugin
        run: |
          cd Plugins/StreamChat
          ue4 package

      # Satisfy marketplace requirements
      - name: ğŸ¥« Move SourceFiles
        shell: bash
        run: |
          mkdir Plugins/StreamChat/dist/Content/SourceFiles
          find Plugins/StreamChat/dist -type f '(' -name "*.png" -o -name "*.svg" ')' -exec mv -i {} Plugins/StreamChat/dist/Content/SourceFiles \;

      - uses: actions/upload-artifact@v2
        with:
          name: StreamChat
          path: |
            Plugins/StreamChat/dist
            !**/Binaries
            !**/Intermediate
        name: ğŸ“ Upload plugin artifact
